

# 1. Installing the VM 

1. Download the ISO from : https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/ choose the "debian-12.11.0-amd64-netinst.iso"
2. Install KVM
```
sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager
```
 
3. Install the VM using below command :
```
sudo virt-install \
	  --name debian12-sugoi \
	  --memory 2048 \
	  --vcpus 2 \
	  --disk size=15,path=/var/lib/libvirt/images/debian12-new.qcow2 \
	  --os-variant debian12 \
	  --location /var/lib/libvirt/images/debian-12.11.0-amd64-netinst.iso \
	  --network network=default \
	  --graphics none \
	  --console pty,target_type=serial \
	  --extra-args 'console=ttyS0,115200n8 serial'
```
## during installation
- When probing software installation choose SSH to enable SSH.
- Choose the proper mirror (ex: Indonesia or Singapore).
- Just go with the flow and choose anything based on the requirement or simply something that suits you.

## check whether the vm is active or not
```
sudo virsh --connect qemu:///system list --all
```

## how to delete and remove the vm
```
sudo virsh --connect qemu:///system shutdown debian12-headless
if doesn't shut down, force it
sudo virsh --connect qemu:///system destroy debian12-headless
```

## what to do inside the VM

>sudo apt update
>sudo apt install openssh-server

get the ip after install the vm using `ip a`

# 2. Deployment

## 2.1. Prerequiresites

```
- Install dotnet sdk in the main host
- Install dotnet runtime/sdk in the VM
```

>**Notes** : It's possible to host it without the runtime by using self-contained deployment

## 2.2. Create .net apps and publish it

Create the .net apps.
```
1. In vscode, ctrl shiftp + p to create new project
2. Choose the preexisting template which is ASP Net Core web api
```

Add below code to the program.cs
```c#
builder.WebHost.ConfigureKestrel(serverOptions =>
{
	serverOptions.ListenAnyIP(5000);
});
```

To generate the dll, use below command in the main host.
```
dotnet publish -c Release -o out, to generate the dll
```

Copy the generated output 
```
scp -r "/media/se-108/Local Data/CSharp_Project/1.Test_raspi_deploy/RaspiSimpleAPI" zankam@192.168.122.184:/home/zankam/apps/myapi
```


# 3. Autostart with systemctl

## 3.1 Enable systemctl
Create service file:
```
sudo nano /etc/systemd/system/myapp.service
```

Paste:
```
[Unit]
Description=My .NET App
After=network.target

[Service]
ExecStart=/usr/bin/dotnet /home/youruser/myapp/MyApp.dll
WorkingDirectory=/home/youruser/myapp
Restart=always
User=youruser

[Install]
WantedBy=multi-user.target

```

Enable + start:
```
sudo systemctl daemon-reexec
sudo systemctl enable myapp.service
sudo systemctl start myapp.service
```

## 3.2 Check log & status
Check status
```
systemctl status myapp.service
```

Check log
```
# View all logs for your service
journalctl -u myapp.service

# Follow logs in real time (like tail -f)
journalctl -u myapp.service -f

# Limit to last 50 lines
journalctl -u myapp.service -n 50
```

## 3.3 Service Control
Start service
```
sudo systemctl start myapp.service
```

Stop service
```
sudo systemctl stop myapp.service
```





# Problems Encountered & Related Stuff
**Problems Encountered** :
- https://stackoverflow.com/questions/47806576/username-is-not-in-the-sudoers-file-this-incident-will-be-reported

**Related Stuff :**
- [[SSH]]
- [[3. Redo in Raspi]]

**Reference : 
- https://learn.microsoft.com/en-us/dotnet/core/install/linux-debian?tabs=dotnet9
- https://www.cherryservers.com/blog/install-kvm-ubuntu